---
import Base from "./Base.astro";
import Header from "./Header.astro";


const {
  position,
  greeting,
  signOff,
  details: { header: headerDetails },
  // New prop for YAML-based cover letter
  letter,
} = Astro.props;

const { name } = headerDetails;

const now = new Date().toLocaleDateString("en-us", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Handle YAML-based cover letter configuration
let finalGreeting = greeting ?? letter?.greeting ?? "Dear Hiring Manager,";
let finalSignOff = signOff ?? letter?.sign_off ?? "Sincerely,";
let finalPosition = position ?? letter?.position ?? "";
let paragraphs: string[] = [];

if (letter && letter.blocks) {
  // Simple variable substitution for {{company}}, {{position}}, etc.
  const vars = {
    ...(letter || {}),
    ...(letter.variables || {}),
  };
  paragraphs = Object.values(letter.blocks).map((block: any) => {
    if (typeof block !== 'string') return '';
    return block.replace(/{{\s*(\w+)\s*}}/g, (_, v) => vars[v] ?? '');
  });
}

// Check if we're using slot content (old style) or YAML blocks (new style)
const hasSlotContent = Astro.slots.has('default');
---

<Base>
  <Header details={headerDetails} />
  <div class="cover-letter-header">
    <div class="position">For position of {finalPosition}</div>
    <div>{now}</div>
  </div>
  <div class="greeting">{finalGreeting}</div>
  
  {hasSlotContent ? (
    <slot />
  ) : (
    paragraphs.map(paragraph => (
      <p>{paragraph}</p>
    ))
  )}
  
  <div class="sign-off">{finalSignOff}</div>
  <div class="name">{name}</div>
</Base>

<style>
  .cover-letter-header {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    margin: 2rem 0 1rem 0;
  }

  .position {
    font-weight: bold;
    text-decoration: underline;
  }

  .greeting {
    margin-bottom: 1rem;
  }

  .sign-off {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .name {
    font-weight: bold;
  }

  p {
    margin-bottom: 1rem;
    line-height: 1.6;
    text-align: justify;
  }
</style>
